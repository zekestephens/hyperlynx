{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Engineer Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:ital,wght@0,100..900;1,100..900&display=swap"
          rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'tickets/css/styles.css' %}">
</head>
<body>
<div id="root" class="container my-4"></div>

<script>
    const USER_ROLE = "{{ user_role }}";
</script>

<script type="module">
    import {useState, useEffect, createElement} from 'https://esm.sh/react';
    import {createRoot} from 'https://esm.sh/react-dom/client';
    import axios from 'https://esm.sh/axios';
    import htm from 'https://unpkg.com/htm?module';

    const html = htm.bind(createElement);

    function Chatbot() {
        // State to hold the array of messages: [{ role: 'user'|'bot', text: '...' }]
        const [messages, setMessages] = useState([]);
        // State for the user's current input text
        const [input, setInput] = useState('');
        // State to manage loading/waiting for AI response
        const [isLoading, setIsLoading] = useState(false);

        useEffect(() => {
            const preset = {
                "role": "model",
                "parts": [{"text": "Hello! I'm ready to create a ticket for you. To get started, I need to know the **location**, **type** of issue, a **summary**, and the **priority**. What are the details?"}]
            };
            setMessages([preset]);

        }, []);


        // Function to send the message to the Django backend
        const sendMessage = async () => {

            if (!input.trim() || isLoading) return; // Prevent sending empty messages

            const userMessage = input;
            const newUserMessage = {"role": "user", "parts": [{"text": userMessage}]};


            // 1. Add user message to the display and clear input
            setMessages(prev => [...prev, newUserMessage]);
            setInput('');
            setIsLoading(true);

            try {
                // 2. Call the Django API endpoint
                const response = await axios.post('/api/chat/', {
                    message: userMessage,
                    history: messages
                });

                // 3. Get the AI's reply from the response
                const botReply = response.data.reply;
                const newBotMessage = {"role": "model", "parts": [{"text": botReply}]};

                // 4. Add the AI reply to the display
                setMessages(prev => [...prev, newBotMessage]);


            } catch (error) {
                console.error("Error sending message to Django:", error);
                const errorMessage = {
                    "role": "model",
                    "parts": [{"text": "Sorry, I couldn\'t connect to the AI service."}]
                };
                setMessages(prev => [...prev, errorMessage]);
            } finally {
                // 5. Stop loading
                setIsLoading(false);
            }


        };

        // Scroll to the bottom of the chat history whenever messages change
        useEffect(() => {
            const historyDiv = document.querySelector('.chat-history');
            if (historyDiv) {
                historyDiv.scrollTop = historyDiv.scrollHeight;
            }
        }, [messages]);

        return html`
            <div class="chatbot-container">
                <div class="chat-history">
                    ${messages.map((msg, index) => html`
                        <div key=${index} class=${'message ' + msg.role}>
                            ${msg.parts[0].text}
                        </div>
                    `)}
                    ${isLoading && html`
                        <div class="loading-indicator">Gemini is typing...</div>`}
                </div>

                <div class="chat-input-area">
                    <input
                            type="text"
                            value=${input}
                            onChange=${(e) => setInput(e.target.value)}
                            onKeyPress=${(e) => e.key === 'Enter' && sendMessage()}
                            placeholder=${isLoading ? "Waiting for response..." : "Ask me anything..."}
                            disabled=${isLoading}
                    />
                    <button onClick=${sendMessage} disabled=${isLoading || !input.trim()}>
                        Send
                    </button>
                </div>
            </div>
        `;
    }

    function EngineerDashboard() {
        const [tickets] = useState([
            {id: 1, title: "Server overload in Dallas DC", date: "2025-11-08"},
            {id: 2, title: "Cooling system check Houston DC", date: "2025-11-07"},
        ]);
        const [chatOpen, setChatOpen] = useState(false);

        const isEngineer = USER_ROLE === "engineer";
        const isDataTech = USER_ROLE === "data_technician";

        return html`
            <div>
                <h1 class="mb-4">${isEngineer ? "Engineer Dashboard" : "Data Technician Dashboard"}</h1>

                <div class="row mb-4">
                    ${tickets.map(t => html`
                        <div class="col-md-6 mb-3">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">${t.title}</h5>
                                    <p class="card-text"><small>Created: ${t.date}</small></p>
                                </div>
                            </div>
                        </div>
                    `)}
                </div>

                ${isEngineer && html`
                    <button class="btn btn-primary floating-btn" onClick=${() => setChatOpen(!chatOpen)}>+</button>
                    ${chatOpen && html`
                        <${Chatbot}/>`}
                `}

                ${isDataTech && html`
                    <div class="card p-3 shadow-sm">
                        <h4>Suggested Tasks</h4>
                        <ul>
                            <li>Check network latency logs in Dallas DC</li>
                            <li>Verify power efficiency in Houston DC</li>
                            <li>Update rack maintenance schedule</li>
                        </ul>
                    </div>
                `}
            </div>
        `;
    }

    const root = createRoot(document.getElementById('root'));
    root.render(html`
        <${EngineerDashboard}/>`);

</script>

<!-- Bootstrap JS (optional, for modals or components) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
